# نظام إدارة الخطابات

## نظرة عامة
نظام إدارة الخطابات هو منصة متكاملة لإنشاء وإدارة الخطابات الرسمية مع دعم كامل للغة العربية. يهدف المشروع إلى تسهيل عمليات إنشاء وتتبع وإدارة الخطابات الرسمية مع ميزات سير العمل وإدارة القوالب والموافقات.

## أهداف المشروع
- توفير نظام متكامل لإدارة الخطابات الرسمية بواجهة سهلة الاستخدام
- دعم سير العمل وعمليات الموافقة على الخطابات
- توفير نظام قوالب مرن وقابل للتخصيص
- إدارة المستخدمين والصلاحيات
- إمكانية تصدير الخطابات بصيغة PDF بجودة عالية
- دعم التوقيعات الإلكترونية والتحقق من صحة الخطابات

## مكونات النظام

### المكونات الأساسية
1. **إدارة الخطابات**: إنشاء وتحرير وتتبع وأرشفة الخطابات
2. **نظام القوالب**: إدارة قوالب الخطابات مع تحديد مناطق الكتابة
3. **سير العمل والموافقات**: طلب موافقات والرد عليها والتتبع
4. **إدارة المستخدمين والصلاحيات**: إدارة حسابات المستخدمين وصلاحياتهم
5. **إدارة الفروع**: تنظيم المستخدمين حسب الفروع
6. **التقارير والإحصاءات**: لوحة تحكم مع إحصاءات ومؤشرات أداء
7. **التصدير والطباعة**: تصدير الخطابات بصيغة PDF عالية الجودة

### التقنيات المستخدمة
- **الواجهة الأمامية**: React مع TypeScript
- **التنسيق**: Tailwind CSS
- **إدارة الحالة**: React Query, Zustand
- **قاعدة البيانات**: Supabase
- **التوثيق**: نظام QR للتحقق من صحة الخطابات
- **تحرير النصوص**: TinyMCE
- **التصدير**: jsPDF و html2canvas

## المجلدات الأساسية

```
/home/project/
├── src/                    # الكود المصدري للتطبيق
│   ├── components/         # مكونات React المشتركة
│   ├── features/           # الميزات المنظمة حسب الوحدات
│   ├── hooks/              # React Hooks المخصصة
│   ├── lib/                # مكتبات ووظائف مساعدة
│   ├── pages/              # صفحات التطبيق
│   ├── providers/          # موفرو السياق (Context Providers)
│   ├── store/              # مخازن إدارة الحالة
│   ├── types/              # تعريفات TypeScript
│   └── routes.tsx          # تعريف مسارات التطبيق
├── public/                 # ملفات ثابتة عامة
├── supabase/               # ملفات هجرة قاعدة البيانات
└── README.md               # وثائق المشروع
```

### وصف المجلدات الرئيسية

- **components**: يحتوي على مكونات React المشتركة المستخدمة في مختلف أجزاء التطبيق
- **features**: تنظيم الكود حسب الميزات مع فصل المكونات والخطافات والأنواع لكل ميزة
- **hooks**: خطافات React المخصصة مثل `useLetters` و `useAuth` و `useWorkflow`
- **lib**: وظائف مساعدة مثل التوثيق والتصدير PDF والاتصال بقاعدة البيانات
- **pages**: صفحات التطبيق المنظمة حسب التنقل
- **providers**: موفرو السياق مثل `AuthProvider` و `ToastProvider`
- **store**: مخازن إدارة الحالة باستخدام Zustand

## إدارة قاعدة البيانات

يستخدم المشروع Supabase كحل متكامل لقاعدة البيانات والمصادقة وتخزين الملفات:

- ملفات الهجرة موجودة في مجلد `supabase/migrations`
- تشمل الجداول الرئيسية: `letters`, `letter_templates`, `users`, `branches`, `signatures`, `approval_requests`
- يوجد سكريبتان لإدارة ملفات الهجرة:
  - `archive-migrations.js`: لأرشفة ملفات الهجرة القديمة
  - `restore-migrations.js`: لاستعادة الملفات من الأرشيف

## ملاحظات وإرشادات للذكاء الاصطناعي

### المشكلات المتكررة والحلول

1. **التعامل مع اللغة العربية**:
   - يجب استخدام التوجيه `rtl` و `text-right` للعناصر النصية
   - تأكد من استخدام خط Cairo للنصوص العربية

2. **محرر النصوص TinyMCE**:
   - قد تواجه مشكلات في تنسيق النصوص العربية
   - تحقق من وجود تهيئة خاصة باللغة العربية في `TinyEditor.tsx`

3. **تصدير PDF**:
   - تأكد من تحميل خطوط Cairo قبل عملية التصدير
   - عملية التصدير تتم عبر `html2canvas` ثم تحويل Canvas إلى PDF

4. **قضايا التوافق المتصفح**:
   - قد تظهر مشكلات في بعض خصائص CSS المتقدمة في متصفحات قديمة
   - استخدم polyfills عند الضرورة

### نصائح للتطوير

1. **تحسين الأداء**:
   - استخدم React Query لإدارة طلبات البيانات وتخزين النتائج
   - تجنب إعادة التقديم غير الضرورية باستخدام `React.memo` و `useMemo`

2. **أمان البيانات**:
   - تحقق دائمًا من صلاحيات المستخدم قبل الوصول إلى البيانات
   - استخدم `RLS (Row Level Security)` في Supabase

3. **إدارة الهجرات**:
   - أرشفة ملفات الهجرة القديمة لتحسين الأداء
   - استخدم سكريبت `archive-migrations.js`

4. **التعامل مع القوالب**:
   - استخدم مكون `TemplateZoneEditor` لتحرير مناطق الكتابة في القوالب
   - تأكد من ضبط موضع QR code في القالب

### التحسينات المقترحة

1. تحسين الأداء في تحميل القوالب الكبيرة
2. إضافة دعم للإخطارات الفورية لطلبات الموافقة
3. تحسين واجهة تحرير مناطق الكتابة
4. تطوير نظام حفظ تلقائي أكثر كفاءة للمسودات

## إدارة ملفات الهجرة

تم إنشاء نظام لأرشفة ملفات هجرة Supabase القديمة للحفاظ على أداء المشروع. يمكنك استخدام السكريبتات التالية:

### أرشفة الملفات القديمة

```bash
node archive-migrations.js
```

هذا السكريبت سينقل الملفات القديمة إلى مجلد `supabase/migrations_archive` مع الاحتفاظ بأحدث 10 ملفات في المجلد الرئيسي.

### استعادة الملفات من الأرشيف

```bash
node restore-migrations.js
```

هذا السكريبت سيستعيد جميع الملفات من مجلد الأرشيف إلى مجلد الهجرة الرئيسي.